<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dev-inject React Vite 测试</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        margin: 0;
        font-size: 2.5rem;
      }

      .header p {
        margin: 10px 0;
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .panel {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        margin-top: 0;
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
      }

      .iframe-wrapper {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        height: 500px;
        position: relative;
        background: #f7fafc;
      }

      .iframe-wrapper iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .iframe-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #718096;
        font-size: 1.1rem;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }

      .controls button {
        background: #4299e1;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .controls button:hover:not(:disabled) {
        background: #3182ce;
        transform: translateY(-1px);
      }

      .controls button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
      }

      .controls button.danger {
        background: #f56565;
      }

      .controls button.danger:hover:not(:disabled) {
        background: #e53e3e;
      }

      .controls button.success {
        background: #48bb78;
      }

      .controls button.success:hover:not(:disabled) {
        background: #38a169;
      }

      .message-log {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 12px;
        height: 300px;
        overflow-y: auto;
        margin: 15px 0;
        line-height: 1.4;
        width: 400px;
      }

      .message-item {
        margin: 5px 0;
        padding: 5px 8px;
        border-radius: 4px;
        border-left: 3px solid transparent;
      }

      .message-item.from-iframe {
        background: rgba(72, 187, 120, 0.15);
        border-left-color: #48bb78;
      }

      .message-item.from-parent {
        background: rgba(66, 153, 225, 0.15);
        border-left-color: #4299e1;
      }

      .message-item.system {
        background: rgba(237, 137, 54, 0.15);
        border-left-color: #ed8936;
      }

      .message-timestamp {
        color: #a0aec0;
        margin-right: 10px;
      }

      .message-type {
        font-weight: bold;
        margin-right: 10px;
      }

      .status-indicator {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 15px;
      }

      .status-connected {
        background: #c6f6d5;
        color: #22543d;
      }

      .status-disconnected {
        background: #fed7d7;
        color: #742a2a;
      }

      .custom-input {
        display: flex;
        gap: 10px;
        margin: 15px 0;
      }

      .custom-input input {
        flex: 1;
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
      }

      .custom-input input:focus {
        outline: none;
        border-color: #4299e1;
      }

      .info-box {
        background: #ebf8ff;
        border: 1px solid #90cdf4;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
      }

      .info-box h4 {
        margin-top: 0;
        color: #2c5282;
      }

      .info-box ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      .info-box li {
        margin: 5px 0;
      }

      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      function App() {
        const [messages, setMessages] = useState([]);
        const [isConnected, setIsConnected] = useState(false);
        const [iframeLoading, setIframeLoading] = useState(true);
        const iframeRef = useRef(null);
        const customInputRef = useRef(null);

        const addMessage = (type, content, source = 'parent') => {
          const timestamp = new Date().toLocaleTimeString();
          setMessages(prev => [
            ...prev,
            {
              type,
              content,
              source,
              timestamp,
              id: Date.now() + Math.random(),
            },
          ]);
        };

        const sendMessageToIframe = (type, data = {}) => {
          const iframe = iframeRef.current;
          if (iframe && iframe.contentWindow) {
            const message = {
              type,
              data,
              timestamp: Date.now(),
              source: 'parent',
            };

            iframe.contentWindow.postMessage(message, '*');
            addMessage('sent', `${type}: ${JSON.stringify(data)}`, 'parent');
          } else {
            addMessage('system', 'iframe 未找到或未加载', 'parent');
          }
        };

        useEffect(() => {
          const handleMessage = event => {
            if (event.source === iframeRef.current?.contentWindow) {
              const { type, data } = event.data;

              if (type === 'iframe-ready') {
                setIsConnected(true);
                setIframeLoading(false);
                addMessage('received', 'iframe 已准备就绪', 'iframe');
              } else if (type === 'monitor-data') {
                const summary = `${data.errors?.length || 0} 错误, ${data.logs?.length || 0} 日志`;
                addMessage('received', `监控数据: ${summary}`, 'iframe');
              } else {
                addMessage(
                  'received',
                  `${type}: ${JSON.stringify(data)}`,
                  'iframe'
                );
              }
            }
          };

          window.addEventListener('message', handleMessage);
          return () => window.removeEventListener('message', handleMessage);
        }, []);

        const handleIframeLoad = () => {
          addMessage('system', 'iframe 已加载完成', 'parent');
          setTimeout(() => {
            sendMessageToIframe('parent-ready', {
              message: '父页面已准备好通信',
            });
          }, 500);
        };

        const clearMessages = () => {
          setMessages([]);
        };

        const sendCustomMessage = () => {
          const text = customInputRef.current?.value || 'Hello from parent!';
          sendMessageToIframe('custom-message', { text });
          if (customInputRef.current) {
            customInputRef.current.value = '';
          }
        };

        return (
          <div className='container'>
            <div className='header'>
              <h1>🚀 dev-inject React Vite 测试</h1>
              <p>测试 iframe 通信和监控功能</p>
              <span
                className={`status-indicator ${isConnected ? 'status-connected' : 'status-disconnected'}`}
              >
                {isConnected ? '✅ 已连接' : '❌ 未连接'}
              </span>
            </div>

            <div className='main-content'>
              <div className='panel'>
                <h2>React 应用 (iframe)</h2>
                <p>下方 iframe 运行在端口 3000</p>

                <div className='iframe-wrapper'>
                  {iframeLoading && (
                    <div className='iframe-loading'>
                      ⏳ 正在加载 React 应用...
                    </div>
                  )}
                  <iframe
                    ref={iframeRef}
                    src='/simple-react-app.html'
                    onLoad={handleIframeLoad}
                    title='React App'
                    sandbox='allow-scripts allow-same-origin allow-forms allow-popups allow-modals'
                  />
                </div>

                <div className='controls'>
                  <button
                    onClick={() => sendMessageToIframe('ping')}
                    disabled={!isConnected}
                  >
                    📤 发送 Ping
                  </button>
                  <button
                    onClick={() => sendMessageToIframe('trigger-error')}
                    disabled={!isConnected}
                    className='danger'
                  >
                    ⚠️ 触发错误
                  </button>
                  <button
                    onClick={() => sendMessageToIframe('request-monitor-data')}
                    disabled={!isConnected}
                    className='success'
                  >
                    📊 请求监控数据
                  </button>
                  <button
                    onClick={() =>
                      sendMessageToIframe('change-theme', { theme: 'dark' })
                    }
                    disabled={!isConnected}
                  >
                    🎨 切换主题
                  </button>
                </div>

                <div className='custom-input'>
                  <input
                    ref={customInputRef}
                    type='text'
                    placeholder='输入自定义消息...'
                    onKeyPress={e => e.key === 'Enter' && sendCustomMessage()}
                  />
                  <button onClick={sendCustomMessage} disabled={!isConnected}>
                    发送
                  </button>
                </div>
              </div>

              <div className='panel'>
                <h2>通信日志</h2>
                <div className='controls'>
                  <button onClick={clearMessages} className='danger'>
                    🗑️ 清除日志
                  </button>
                </div>
                <div className='message-log'>
                  {messages.length === 0 ? (
                    <div
                      style={{
                        color: '#a0aec0',
                        textAlign: 'center',
                        marginTop: '100px',
                      }}
                    >
                      等待消息...
                      <br />
                      <small>启动 React 服务器后开始通信</small>
                    </div>
                  ) : (
                    messages.map(msg => (
                      <div
                        key={msg.id}
                        className={`message-item from-${msg.source}`}
                      >
                        <span className='message-timestamp'>
                          {msg.timestamp}
                        </span>
                        <span className='message-type'>
                          {msg.source === 'iframe'
                            ? '📨'
                            : msg.source === 'parent'
                              ? '📤'
                              : '⚙️'}{' '}
                          {msg.type.toUpperCase()}
                        </span>
                        <span>{msg.content}</span>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

            <div className='panel'>
              <h2>📋 使用说明</h2>
              <div className='info-box'>
                <h4>1. 启动服务</h4>
                <ul>
                  <li>
                    主页面服务：<code>http://localhost:9001</code> ✅ (已启动)
                  </li>
                  <li>
                    React 开发服务器：
                    <code>cd examples/react-vite-test && npm run dev</code> ⏳
                    (需要启动)
                  </li>
                </ul>
              </div>

              <div className='info-box'>
                <h4>2. 测试通信功能</h4>
                <ul>
                  <li>
                    <strong>发送 Ping：</strong>测试基本通信
                  </li>
                  <li>
                    <strong>触发错误：</strong>在 iframe 中制造错误并监控
                  </li>
                  <li>
                    <strong>请求监控数据：</strong>获取 iframe 中的监控信息
                  </li>
                  <li>
                    <strong>自定义消息：</strong>发送任意消息到 iframe
                  </li>
                </ul>
              </div>

              <div className='info-box'>
                <h4>3. 监控功能</h4>
                <ul>
                  <li>在 iframe 中按 F12 打开开发者工具</li>
                  <li>
                    输入 <code>DevMonitor.showPanel()</code> 查看监控面板
                  </li>
                  <li>
                    输入 <code>DevMonitor.getData()</code> 获取监控数据
                  </li>
                  <li>监控数据会自动发送到父页面</li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
